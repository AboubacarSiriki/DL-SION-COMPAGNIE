{% extends "base.html"%}
{% block centre%}
<div class="home-content">
        <div class="overview-boxes">
          <div class="box">
            <div class="right-side">
              <div class="box-topic">stocks</div>
              <div class="number">60</div>
              <div class="indicator">
                <i class="bx bx-up-arrow-alt"></i>
                <span class="text"></span>
              </div>
            </div>
            <i class="bx bx-cart-alt cart"></i>
          </div>
          <div class="box">
            <div class="right-side">
              <div class="box-topic">Faible</div>
              <div class="number">50</div>
              <div class="indicator">
                <i class="bx bx-up-arrow-alt"></i>
                <span class="text"></span>
              </div>
            </div>
            <i class="bx bxs-cart-add cart two"></i>
          </div>
          <div class="box">
            <div class="right-side">
              <div class="box-topic">Montant</div>
              <div class="number">200 000K</div>
              <div class="indicator">
                <i class="bx bx-down-arrow-alt down"></i>
                <span class="text"></span>
              </div>
            </div>
            <i class="bx bxs-cart-download cart four"></i>
          </div>
        </div>

    <div class="sales-boxes">
          <div class="recent-sales box">
            <div class="title">
              <p>Stocks</p><button  id="open-popup">Faire une mise à jour</button>
            </div>
              <div class="sales-details">
        <ul class="details">
          <li class="topic">Nom</li>
          {% for row in resultat1 %}
          <li><a href="#">{{ row[0] }}</a></li>
          {% endfor %}
        </ul>
        <ul class="details">
          <li class="topic">Catégorie</li>
          {% for row in resultat1 %}
          <li><a href="#">{{ row[1] }}</a></li>
          {% endfor %}
        </ul>
        <ul class="details">
            <li class="topic">Etat</li>
            {% for row in resultat1 %}
                {% if row[3] > row[2] %}
                    <li><a href="#" style="color:red;">Faible</a></li>
                {% elif row[3] == 0 %}
                    <li><a href="#" style="color:red;">Vide</a></li>
                {% else %}
                    <li><a href="#" style="color:blue;">Bon</a></li>
                {% endif %}
            {% endfor %}

        </ul>

        <ul class="details">
          <li class="topic">Stock</li>
          {% for row in resultat1 %}
          <li><a href="#">{{ row[2] }}</a></li>
          {% endfor %}
        </ul>
        <ul class="details">
          <li class="topic">Action</li>
          {% for row in resultat1 %}
          <div class="icon">
            <i class='bx bx-edit edit-icon' style='font-size: 30px; color: blue;'></i>
            <i class='bx bx-trash delete-icon' style='font-size: 30px; color: red;'></i>
          </div>
          {% endfor %}
        </ul>
      </div>
            <div class="button">
              <a href="#">Voir plus</a>
            </div>
          </div>

        </div><br>

        <div class="sales-boxes">
          <div class="recent-sales box">
            <div class="title">
              <p>Liste des mises à jour stocks</p>
            </div>
            <div class="sales-details">
              <ul class="details">
                <li class="topic">Date </li>
                {% for row in resultat %}
                  <li><a href="#">{{ row[3] }}</a></li>
                  {% endfor %}
              </ul>
              <ul class="details">
                  <li class="topic">Produit</li>
                  {% for row in resultat %}
                  <li><a href="#">{{ row[0] }}</a></li>
                  {% endfor %}
              </ul>
              <ul class="details">
                  <li class="topic">Quantité ajouté</li>
                  {% for row in resultat %}
                  <li><a href="#">{{ row[2] }}</a></li>
                  {% endfor %}
              </ul>
              <ul class="details">
                  <li class="topic">Action</li>
                  {% for row in resultat %}
                  <div class="icon">
                    <i class='bx bx-edit edit-icon' style='font-size: 30px; color: blue;'></i>
                    <i class='bx bx-trash delete-icon' style='font-size: 30px; color: red;'></i>
                  </div>
                  {% endfor %}
              </ul>
            </div>
            <div class="button">
              <a href="#">Voir plus</a>
            </div>
          </div>
        </div><br>

      <div id="popup" class="popup">
        <div class="popup-content">
            <span class="close" id="close-popup">&times;</span>
            <h2>Ajout de stock</h2><br>
            <form id="stock-form" method="post" action="{{url_for('stock')}}" >
                <label for="produit">Produit</label>
                <select id="produit" name="produit" required>
                    <option value="">Sélectionnez un produit</option>
                    {% for produit in produits %}
                        <option value="{{ produit[0] }}">{{ produit[1] }}</option>
                    {% endfor %}
                </select>
                <label for="nombre">Nombre</label>
                <input type="number" id="nombre" name="nombre" required>
                <button id="add-button">Ajouter</button>


            <table id="stock-table">
                <thead>
                    <tr>
                        <td>Id</td>
                        <td>Nom</td>
                        <td>Quantité</td>
                        <td>Prix</td>
                        <td>Catégorie</td>
                    </tr>
                </thead>
                <tbody>

                </tbody>
            </table>

            <div><button class="btn12"><a href="{{url_for('stock')}}">Retour</a></button>
                <button id="btn11" type="submit">Valider</button>
            </div>
            </form>
        </div>
      </div>
    </div>
</div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var addButton = document.querySelector('#add-button');
            var stockTable = document.querySelector('#stock-table tbody');

            addButton.addEventListener('click', function(event) {
                event.preventDefault();

                var produitId = document.querySelector('#produit').value;
                var nombre = document.querySelector('#nombre').value;

                fetch('/get_product_info/' + produitId)
                    .then(response => response.json())
                    .then(data => {
                        var newRow = document.createElement('tr');
                        newRow.innerHTML = '<td>' + produitId + '</td>' +
                                            '<td>' + data.nom + '</td>' +
                                            '<td>' + nombre + '</td>' +
                                            '<td>' + data.prix + '</td>' +
                                            '<td>' + data.categorie + '</td>';

                        stockTable.appendChild(newRow);
                    })
                    .catch(error => {
                        console.error('Erreur lors de la récupération des informations du produit :', error);
                    });
            });
        });
    </script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var submitButton = document.querySelector('#submit-button');
    var stockTable = document.querySelector('#stock-table tbody');

    submitButton.addEventListener('click', function(event) {
        event.preventDefault();

        // Parcourir toutes les lignes du tableau
        var rows = stockTable.querySelectorAll('tr');
        rows.forEach(function(row) {
            // Récupérer les valeurs des cellules de la ligne
            var produitId = row.querySelector('.produit-id').textContent;
            var nom = row.querySelector('.nom').textContent;
            var quantite = row.querySelector('.quantite').textContent;
            var prix = row.querySelector('.prix').textContent;
            var categorie = row.querySelector('.categorie').textContent;

            // Créer un formulaire pour envoyer les données
            var form = new FormData();
            form.append('produitId', produitId);
            form.append('nom', nom);
            form.append('quantite', quantite);
            form.append('prix', prix);
            form.append('categorie', categorie);

            // Enregistrer les valeurs dans la base de données via une requête AJAX
            fetch('/stock', {
                method: 'POST',
                body: form
            })
            .then(response => {
                if (response.ok) {
                    console.log('Ligne enregistrée avec succès dans la base de données');
                } else {
                    console.error('Erreur lors de l\'enregistrement de la ligne dans la base de données');
                }
            })
            .catch(error => {
                console.error('Erreur lors de l\'enregistrement de la ligne dans la base de données :', error);
            });
        });
    });
});

</script>

{% endblock %}